---
title: "Predicting Seasonal Influenza Hospitalizations"
author: "Kevin W. McConeghy, Jason R. Gantenberg, Andrew R. Zullo, Chanelle J. Howe, ... (author list tentative)"
date: "Compiled: `r Sys.Date()`"
output: pdf_document
bibliography: flurefs.bib
csl: mathematical-medicine-and-biology.csl
link-citations: yes
geometry: "left=1.75in,right=1.75in,top=1.5in,bottom=1.5in"
header-includes:
- \renewcommand{\thefootnote}{\roman{footnote}}
---

# Purpose

## Question 1

Which of a set of candidate statistical models most closely fits target features in a distribution of hypothetical influenza hospitalization curves?

## Secondary question

Stratified by the Centers for Disease Control and Prevention's (CDC) season severity designation [@Centers_for_Disease_Control_and_Prevention2016-nr; @Biggerstaff2018-ns], which of a set of candidate statistical models most closely fits target features in a distribution of hypothetical influenza hospitalization curves?

# Background

## _MMWR_ Weeks

All weeks will be specified based on the _MMWR_ Week convention [@Centers_for_Disease_Control_and_Prevention_undated-pu]. Referred to as "epiweeks", _MMWR_ weeks are integer values assigned to each week of the year, ranging from 1--53 [@Centers_for_Disease_Control_and_Prevention_undated-pu]. A typical flu season begins in epiweek 40. For the purposes of our analysis, we will renumber epiweeks to begin at 1 in epiweek 40 and end at 52 (or 53, in leap years) in epiweek 39.

## Season severity

Recently, the CDC developed a methodology to designate the severity of each flu season based on hospitalizations and mortality [@Biggerstaff2018-ns; @Centers_for_Disease_Control_and_Prevention2018-mf]. Severity designations are assigned by age group (child, adult, over 65) and overall [@Biggerstaff2018-ns]. For the purposes of the current study, we will match historical seasons with their corresponding overall severity designations.

# General approach

1. Fit a quadratic trend filter model [@Kim2009-bz; @Tibshirani2014-tr; @Brooks2015-fl] to empirical FluSurv-NET hospitalization data for the seasons 2003–2004 through 2017–2018, based in part on the approach described by Brooks et al. [@Brooks2015-fl].

1. Simulate _N_ hypothetical influenza hospitalization curves using the empirical Bayes approach described in _Curve fitting and simulation_.

1. For each candidate statistical model, find the set of variables that results in best fit to the distribution of hypothetical influenza hospitalization curves. Compare the best model for each model type against pre-specified target parameters to determine which candidate statistical model performs best across these targets.

# Targets

For each of the following target parameters, we will calculate the root mean squared errors (RMSE), Bayesian information criterion (BIC), and relative bias for each of the best-fitting candidate statistical model types:

1. _Peak height_ - largest number of hospitalizations in a single week
1. _Peak week_ -  the week in which this peak height occurred
1. _Total hospitalizations_ - the cumulative number of hospitalizations in the season

These targets follow in part from [@Brooks2015-fl], who focused on influenza-like illness rather than hospitalizations.

```{r flusurv-net_fig, echo = FALSE, fig.fullwidth = TRUE, fig.cap = "Empirical hospitalization curves, peak weeks, and peak number of cases --- 2003--2017 (Source: FluSurv-NET, CDC). Data excludes 2009--2010 pandemic influenza season and 2018--2019 due to no official severity designation."}
knitr::include_graphics("hospital-curve-empirical.pdf")
```

# Curve fitting and simulation

We will simulate hypothetical influenza hospitalization curves using a modified version of the curve-fitting approach described by Brooks et al. [@Brooks2015-fl].

First, using the `glmgen` [@Brooks2015-fl] package in R, we will fit a quadratic trend filter [@Kim2009-bz; @Tibshirani2014-tr; @Brooks2015-fl] to each empirical hospitalization curve released by the CDC [@Centers_for_Disease_Control_and_Prevention2016-nr], beginning with the 2003--2004 season.

For each season $s$ and week $i$, Brooks et al. conceptualize a seasonal influenza curve as some function plus noise [@Brooks2015-fl]^[Brook et al. use their method to forecast a current flu season, where $b$ represents the current season's epidemic threshold of weighted influenza-like illness percent. Because hospitalization curves have a lower bound of 0, we drop $b$ from the original equation.]:

$$y^s_i = f^s (i) + \epsilon^s_i, \epsilon \sim N(0, \tau^s),$$

where

$$f^s (i) = \frac{\theta}{\text{max}_j f(j)} \left[ f \left( \frac{i - \mu}{v} + \genfrac{}{}{0pt}{}{\text{arg max }{j}} f (j) \right) \right].$$

For each empirical season $s$, we fit a quadratic trend filter and average the residuals over $i$ to estimate $\tau^s$:

$$\left( \hat{\tau}^s \right)^2 = \genfrac{}{}{0pt}{}{\text{avg}}{i} \left[ y^s_i - \hat{f}^s (i) \right]^2.$$

We use the fitted trend filters in the curve simulation procedure as $f(j)$), where $j$ represents the indicator for a given week in the trend filter model for the corresponding season.^[In the Brooks paper, what $j$ stood for was not defined explicitly. After studying the paper in detail and simulating my own curves, I believe the only sensible interpretation is the one provided in this analysis plan.] introducing noise for each simulated weekly hospitalization count based this estimate of $\tau^2$.

We alter the original curve formula to impose a lower bound of 0 via the following transformation of $\hat{y}^s_i$, denoted below as $\hat{z}^s_i$:

$$\hat{z}^s_i = 0.5 \bigg( | \hat{y}^s_i | + \hat{y}^s_i \bigg)$$


## Parameters in quadratic trend filtering model

The hypothetical influenza hospitalization curves are simulated using the following sampling scheme for each parameter used to simulate the hospitalization rate in week $i$, using the shape of season $s$ as a starting point ($y^s_i$). Note that all notation included below either is adapted from or appears in [@Brooks2015-fl].

$$\big< f, o, \nu, \theta, \mu \big>$$

## $f$ : Shape

$f \sim U \{ \hat{f} : \text{historical season } s \}$

## $\sigma$ : Noise

$\sigma \sim U \{\hat{\tau}^s \text{ : historical season } s \}$

## $\theta$ : Peak height

$\theta \sim U\left[\theta_m , \theta_M\right]$^[Brooks et al. say they get "unbiased estimators" for the minimum ($\theta_m$) and maximum ($\theta_M$) peak heights, respectively. However, given their notation does not seem to indicate that these parameters are estimates, I am using the observed minimum and maximum heights from the CDC data.]

Results in the following curve:

$f_3(i) = f_2(i - \mu + \text{arg max}_j f_2(j))$

## $\nu$ : Pacing

Curve-stretching around peak week:

$\nu \sim U[0.75, 1.25]$

Results in following curve:

$f_4 (i) = f_3 \left( \frac{i - \text{arg max}_j \text{ } f_3 (j)}{\nu} + \text{arg max}_j \text{ } f_3 (j) \right)$


# Candidate models

## Serfling model (least squares)

Modified from [@McConeghy_undated-ps]:

$$Y = \beta_0 \alpha + \beta_1 t + \beta_rX_r + ... + \beta_p cos \left( \frac{2 \pi t}{52} \right) + \beta_q sin \left( \frac{2 \pi t}{52} \right)$$

Where $t$ = time (week), subscript $r$ denotes a vector of $\beta$ coefficients and variables, and subscripts $p$ and $q$ take on particular numbers based on the length of $r$.


## Modified Serfling model

Modified from [@McConeghy_undated-ps]:

$$y = \alpha_0 + \beta_1 t + \beta_2 Flu_t + \beta_p X_p + ... + sin \left( \frac{2 \pi t}{period} \right) + cos \left( \frac{2 \pi t}{period} \right) + u$$

Where $t$ = time (week) and subscript $p$ denotes a vector of $\beta$ coefficients and variables.


## Generalized additive model (Prophet)

This model will be implemented using the R package _prophet_ [@Taylor2018-pl], which implements a generalized additive modeling approach developed by engineers at Facebook, Inc.

The general form of the equation that will be fit to the hypothetical influenza hospitalization curves:

$$y(t)= g(t) + ... + h(t) + \epsilon_t,$$

where $g(t)$ models nonperiod trends and $h(t)$ stands for a vector of holidays or other events that are known to correlate with flu hospitalization [@Brooks2015-fl]. As with the Serfling and modified Serfling models, the Prophet model will include additional model terms included to improve fit.


## Model terms

The following model terms will be entered as predictor variables to be considered for each model:

a) Cyclical terms (Serfling, Fourier, etc.)

a) Historical (empirical) flu hospitalizations

a) Historical data on viral activity (NREVSS), outpatient surveillance (ILI-Net)

a) Average weekly temperature

a) Climate factors (e.g., prior summer temperatures)

a) Lags and leads of c) or d)

a) Indicators for weeks of Thanksgiving and/or Christmas [@Brooks2015-fl; @Taylor2018-pl]

Automated variable selection be used to select the best-fitting model for each model type using 2, 3, 4, and 5 prior seasons to predict the $n^{th}$ season's curve.

In each case, prior seasons will be drawn from the distribution of hypothetical hospitalization curves and concatenated.

# Goodness of fit

- Root mean squared error (RMSE)

- Relative bias

Measures of fit will be calculated for each model against each of the target parameters (_i.e._, peak height, peak week, cumulative hospitalizations).^[Question for Dr. Naimi: Should we be doing cross-validation or sample-splitting given the aims of this analysis? We can simulate an arbitrary number of hypothetical hospitalization curves, so the limited number of historical flu season available may not be an issue.]


## Sensitivity analysis

_Challenge_

The composition of institutions reflected in the FluSurv-NET has changed over time [@Centers_for_Disease_Control_and_Prevention_undated-vt; @Kandula2019-tg], meaning the FluSurv-NET estimates for influenza-related hospitalizations may not be comparable across time. \bigskip

_Response_

Redo the analysis three times: one for each set of years in which the same participating institutions reported flu data to CDC. See [@Centers_for_Disease_Control_and_Prevention_undated-vt] for more information.

## References

\footnotesize
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent
